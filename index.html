<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CubaChat Pro</title>
    <style>
        /* Estilo base sin cambios en la estructura funcional */
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: #e5ddd5; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Cabecera con sombra */
        #cabecera { background: #075e54; color: white; padding: 15px; text-align: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; }
        
        /* Área de mensajes con el fondo de WhatsApp que pediste */
        #mensajes { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-repeat: repeat;
        }
        
        /* Globos de mensaje mejorados visualmente */
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 75%; box-shadow: 0 1px 1px rgba(0,0,0,0.1); font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .msg b { display: block; font-size: 12px; margin-bottom: 3px; }
        
        /* Colores de los globos */
        .enviado { background: #dcf8c6; align-self: flex-end; border-top-right-radius: 0; }
        .recibido { background: white; align-self: flex-start; border-top-left-radius: 0; }

        /* Barra de entrada de texto moderna */
        #controles { background: #f0f0f0; padding: 10px; display: flex; gap: 8px; align-items: center; }
        input { flex: 1; padding: 12px 15px; border-radius: 25px; border: 1px solid #ddd; outline: none; font-size: 15px; }
        button { background: #075e54; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 20px; flex-shrink: 0; }
        
        #status { font-size: 10px; color: red; text-align: center; background: #ffebeb; }
    </style>
</head>
<body>
    <div id="cabecera">CubaChat - <span id="miNombre">...</span></div>
    <div id="status"></div>
    <div id="mensajes"></div>
    <div id="controles">
        <input type="text" id="mensajeInput" placeholder="Escribe un mensaje..." autocomplete="off">
        <button id="btnEnviar">➤</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Mantenemos tus credenciales intactas
        const firebaseConfig = {
            apiKey: "AIzaSyCfOBCYgEEfgKC53t-v2G6ll_XwD9nh6C8",
            authDomain: "cubachat-6f674.firebaseapp.com",
            projectId: "cubachat-6f674",
            storageBucket: "cubachat-6f674.firebasestorage.app",
            messagingSenderId: "351613355145",
            appId: "1:351613355145:web:e8e6939aac0f08ffa33258"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const statusDiv = document.getElementById("status");

        // Seguimos usando la misma clave de usuario para no perder la sesión
        let usuario = localStorage.getItem("chat_user_v6");
        if(!usuario) {
            usuario = prompt("Tu nombre:");
            if(!usuario) usuario = "Anon" + Math.floor(Math.random() * 100);
            localStorage.setItem("chat_user_v6", usuario);
        }
        document.getElementById("miNombre").innerText = usuario;

        // Función para que cada usuario tenga un color distinto en su nombre
        const obtenerColor = (nombre) => {
            let hash = 0;
            for (let i = 0; i < nombre.length; i++) {
                hash = nombre.charCodeAt(i) + ((hash << 5) - hash);
            }
            return `hsl(${Math.abs(hash) % 360}, 65%, 35%)`;
        };

        const input = document.getElementById("mensajeInput");
        const btn = document.getElementById("btnEnviar");

        // Función de envío idéntica a la que ya te funciona
        const enviar = async () => {
            if(input.value.trim() !== "") {
                const texto = input.value;
                input.value = "";
                try {
                    await addDoc(collection(db, "mensajes"), {
                        autor: usuario,
                        texto: texto,
                        timestamp: serverTimestamp()
                    });
                } catch (e) { statusDiv.innerText = "Error: " + e.message; }
            }
        };

        btn.onclick = enviar;
        input.onkeypress = (e) => { if(e.key === 'Enter') enviar(); };

        // Función de lectura con las mejoras visuales en los nombres
        const q = query(collection(db, "mensajes"), orderBy("timestamp"));
        onSnapshot(q, (snapshot) => {
            const contenedor = document.getElementById("mensajes");
            contenedor.innerHTML = "";
            snapshot.forEach((doc) => {
                const d = doc.data();
                if(d.texto) {
                    const esMio = d.autor === usuario;
                    const div = document.createElement("div");
                    div.className = "msg " + (esMio ? "enviado" : "recibido");
                    
                    // Aplicamos el color al nombre si no es nuestro
                    const colorNombre = esMio ? "#075e54" : obtenerColor(d.autor);
                    div.innerHTML = `<b style="color: ${colorNombre}">${d.autor}</b>${d.texto}`;
                    contenedor.appendChild(div);
                }
            });
            contenedor.scrollTop = contenedor.scrollHeight;
        }, (error) => { statusDiv.innerText = "Error de carga: " + error.message; });
    </script>
</body>
</html>